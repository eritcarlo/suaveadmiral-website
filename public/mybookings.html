<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Bookings - Suave Barbershop</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="mybookings.css">
  <link rel="stylesheet" href="reschedule-modal.css">
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <div id="loading-screen" style="display:none;">
    <img src="suavelogo.png" alt="Loading...">
  </div>

  <div class="page-wrapper">
    <!-- HEADER WITH NAVBAR (matching homepage) -->
    <nav>
      <img src="suavelogo.png" alt="Suave Logo">
      <h1 class="brand-name">Suave Barbershop</h1>
      <ul>
        <li><a href="/home" class="nav-link">HOME</a></li>
        <li><a href="javascript:void(0)" class="nav-link" id="navBookNowBtn">BOOK NOW</a></li>
        <li><a href="/mybookings" class="nav-link active">MY BOOKINGS</a></li>
      </ul>

      <!-- Notifications -->
      <div class="notification-bell" id="notificationBell">
        <i class="fas fa-bell"></i>
        <span id="notificationCount" class="notification-count" style="display: none;">0</span>
        
        <!-- Notification Dropdown -->
        <div class="notification-dropdown" id="notificationDropdown">
          <div class="notification-dropdown-header">
            <h4>Notifications</h4>
            <button class="mark-all-read" id="markAllReadBtn" title="Mark all as read">
              <i class="fas fa-check-double"></i>
            </button>
          </div>
          <div class="notification-dropdown-content" id="notificationDropdownContent">
            <div class="notification-loading">Loading notifications...</div>
          </div>
        </div>
      </div>

      <!-- Profile with Dropdown -->
      <div class="profile-dropdown">
        <div class="profile" id="profileBtn">
          <img id="navbar-profile-pic" src="default-profile.svg" alt="Profile">
        </div>
        <div class="dropdown-menu" id="dropdownMenu">
          <a href="/profile">Profile</a>
          <a href="/forgot">Change Password</a>
          <a href="javascript:void(0)" id="logoutBtn">Logout</a>
        </div>
      </div>
    </nav>

    <!-- Title -->
    <h2> MY BOOKINGS </h2>

    <!-- Bookings List -->
    <div class="bookings-container" id="bookings-container"></div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="book-another-btn" id="bookAnotherBtn">
        <i class="fas fa-calendar-plus"></i>
        Book Another Appointment
      </button>
      <button class="history-btn" id="historyBtn">
        <i class="fas fa-history"></i>
        History
      </button>
    </div>

    <!-- Services Modal -->
    <div id="services-modal" class="services-modal">
      <div class="services-modal-content">
        <span class="close-services-modal">&times;</span>
        <h2 class="services-title">SELECT SERVICES</h2>
        <div class="services-container">
          <div class="service-box" data-service="HAIRCUT" data-price="250">
            <i class="fa-solid fa-scissors"></i>
            <p>HAIRCUT</p>
            <div class="service-price">₱250</div>
          </div>
          <div class="service-box" data-service="CUT AND SHAVE" data-price="300">
            <i class="fa-solid fa-scissors"></i>
            <p>CUT AND SHAVE</p>
            <div class="service-price">₱300</div>
          </div>
        </div>
        <!-- Loading overlay -->
        <div class="service-loading">
          <img src="suavelogo.png" alt="Loading...">
        </div>
      </div>
    </div>

    <!-- Modal Dialog -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modal-message"></div>
        <div id="modal-buttons">
          <button id="modal-ok" class="modal-btn">OK</button>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
      <div class="modal-content" style="text-align: center;">
        <span class="close-confirm">&times;</span>
        <div id="confirm-message" style="font-size: 1.1em; margin-bottom: 10px;"></div>
        <div id="confirm-notice" class="confirm-notice" style="color: #dc3545; margin: 15px 0; font-size: 0.9em; font-style: italic;">
          Please be advised that any payments made are non-refundable as per our booking policy.
        </div>
        <div id="confirm-buttons" style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
          <button id="confirm-yes" class="modal-btn confirm-btn" style="background-color: #dc3545; color: white; padding: 8px 20px; border: none; border-radius: 5px; cursor: pointer;">Yes</button>
          <button id="confirm-no" class="modal-btn cancel-btn" style="background-color: #6c757d; color: white; padding: 8px 20px; border: none; border-radius: 5px; cursor: pointer;">No</button>
        </div>
      </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="modal history-modal">
      <div class="modal-content history-modal-content">
        <span class="close-history">&times;</span>
        <h2><i class="fas fa-history"></i> Booking History</h2>
        
        <!-- Filter Buttons -->
        <div class="history-filters">
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="done">Done</button>
          <button class="filter-btn" data-filter="cancelled">Cancelled</button>
        </div>
        
        <!-- History Content -->
        <div id="history-content" class="history-content">
          <div class="history-loading">
            <i class="fas fa-spinner fa-spin"></i>
            Loading history...
          </div>
        </div>
        
        <!-- Empty State -->
        <div id="history-empty" class="history-empty" style="display: none;">
          <i class="fas fa-calendar-times"></i>
          <p>No booking history found.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>
    <p>© Marco Lorenzo Reyes, Rasheed Kenian Saladino, Angelo Fronda and John Carlo Erit</p>
  </footer>

  <!-- Reschedule Modal -->
  <div id="reschedule-modal" class="modal reschedule-modal">
    <div class="modal-content">
      <span class="close-reschedule">&times;</span>
      <h2><i class="fas fa-calendar-alt"></i> Reschedule Booking</h2>
      
      <div class="reschedule-form">
        <!-- Barber Selection -->
        <div class="form-group">
          <label for="reschedule-barber">Choose Barber:</label>
          <select id="reschedule-barber" required>
            <option value="">Choose a barber</option>
          </select>
        </div>

        <!-- Date Selection -->
        <div class="form-group">
          <label for="reschedule-date">Select Date:</label>
          <input type="date" id="reschedule-date" required>
        </div>

        <!-- Time Selection -->
        <div class="form-group">
          <label for="reschedule-time">Select Time:</label>
          <select id="reschedule-time" disabled required>
            <option value="">Select date and barber first</option>
          </select>
        </div>

        <!-- Button Group -->
        <div class="modal-actions">
          <button id="cancel-reschedule" class="btn-secondary">Cancel</button>
          <button id="confirm-reschedule-booking" class="btn-primary">Confirm</button>
        </div>

        <!-- Loading Overlay -->
        <div class="reschedule-loading">
          <i class="fas fa-spinner fa-spin"></i>
          <span>Please wait...</span>
        </div>
      </div>
    </div>
  </div>

  <script src="profile-manager.js"></script>
  <script src="reschedule-handler.js"></script>
  <script src="final-confirm-modal.js"></script>
  <script>
    // Modal functions
    function showModal(message) {
      document.getElementById("modal-message").textContent = message;
      document.getElementById("modal").style.display = "block";
    }

    function hideModal() {
      document.getElementById("modal").style.display = "none";
    }

    // Confirmation modal functions
    function showConfirmModal(message) {
      return new Promise((resolve) => {
        document.getElementById("confirm-message").textContent = message;
        document.getElementById("confirm-modal").style.display = "block";
        
        const yesBtn = document.getElementById("confirm-yes");
        const noBtn = document.getElementById("confirm-no");
        const closeBtn = document.querySelector(".close-confirm");
        
        function cleanup() {
          yesBtn.removeEventListener("click", handleYes);
          noBtn.removeEventListener("click", handleNo);
          closeBtn.removeEventListener("click", handleNo);
          document.getElementById("confirm-modal").style.display = "none";
        }
        
        function handleYes() {
          cleanup();
          resolve(true);
        }
        
        function handleNo() {
          cleanup();
          resolve(false);
        }
        
        yesBtn.addEventListener("click", handleYes);
        noBtn.addEventListener("click", handleNo);
        closeBtn.addEventListener("click", handleNo);
      });
    }

    // Modal event listeners
    document.querySelector(".close").addEventListener("click", hideModal);
    document.getElementById("modal-ok").addEventListener("click", hideModal);
    document.getElementById("modal").addEventListener("click", function (e) {
      if (e.target === this) hideModal();
    });

    document.getElementById("confirm-modal").addEventListener("click", function (e) {
      if (e.target === this) {
        document.getElementById("confirm-modal").style.display = "none";
      }
    });

    // Loader effect
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.getElementById('loading-screen').style.opacity = '0';
        setTimeout(() => {
          document.getElementById('loading-screen').style.display = 'none';
        }, 500);
      }, 1200);
    });

    // Navigation loader effect (optional, like homepage)
    function addLoaderEffect(selector) {
      document.querySelectorAll(selector).forEach(link => {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          const loader = document.getElementById("loading-screen");
          loader.style.display = "flex";
          setTimeout(() => {
            window.location.href = this.href;
          }, 800);
        });
      });
    }
    addLoaderEffect(".nav-link");

    // ========= Profile Dropdown =========
    const profileBtn = document.getElementById("profileBtn");
    const dropdownMenu = document.getElementById("dropdownMenu");

    if (profileBtn && dropdownMenu) {
      profileBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle("show");
      });

      window.addEventListener("click", (e) => {
        if (!profileBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
          dropdownMenu.classList.remove("show");
        }
      });
    }

    // ========= Notification Bell =========
    const notificationBell = document.getElementById('notificationBell');
    const notificationDropdown = document.getElementById('notificationDropdown');
    
    if (notificationBell && notificationDropdown) {
      notificationBell.addEventListener('click', function(e) {
        e.stopPropagation();
        notificationDropdown.classList.toggle('show');
        
        // Load notifications when dropdown is opened
        if (notificationDropdown.classList.contains('show')) {
          loadDropdownNotifications();
        }
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!notificationBell.contains(e.target)) {
          notificationDropdown.classList.remove('show');
        }
      });
    }
    
    // Mark all notifications as read
    const markAllReadBtn = document.getElementById('markAllReadBtn');
    if (markAllReadBtn) {
      markAllReadBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        markAllNotificationsAsRead();
      });
    }

    // Load profile picture from localStorage
    // Profile picture loading is now handled by ProfileManager
    
    // ========= Logout =========
    // Handled by centralized logout-confirm.js
    // logout-confirm.js intercepts clicks on #logoutBtn and shows confirmation modal

    // Load notifications
    loadNotifications();

    // ========= Navbar Book Now Button =========
    const navBookNowBtn = document.getElementById("navBookNowBtn");
    if (navBookNowBtn) {
      navBookNowBtn.addEventListener("click", function(e) {
        e.preventDefault();
        openServicesModal();
      });
    }

    // Note: Reschedule functionality is handled by reschedule-handler.js

    // Bookings rendering
    document.addEventListener("DOMContentLoaded", function() {
      // Initialize ProfileManager for real-time profile picture updates
      const profileManager = new ProfileManager();
      profileManager.init();
      
      const container = document.getElementById("bookings-container");
      const loading = document.getElementById("loading-screen");
      loading.style.display = "flex";

      function getPaymentClass(method) {
        if (!method) return "payment-notpaid";
        method = method.toLowerCase();
        if (method === "cash") return "payment-cash";
        if (method === "gcash") return "payment-gcash";
        if (method === "paymaya") return "payment-paymaya";
        return "payment-notpaid";
      }
      function getStatusClass(statusText) {
        return statusText === "Paid" ? "status-paid" : "status-pending";
      }

      fetch("/api/my-bookings")
        .then(res => res.json())
        .then(data => {
          loading.style.display = "none";
          if (!data.success || !data.bookings || data.bookings.length === 0) {
            container.innerHTML = "<p>No bookings found.</p>";
            return;
          }
          data.bookings.forEach(booking => {
            let statusText = "Pending";
            if (booking.payment_method) {
              const method = booking.payment_method.toLowerCase();
              if (method === "gcash" || method === "paymaya") {
                statusText = "Paid";
              }
            }
            const paymentClass = getPaymentClass(booking.payment_method);
            const statusClass = getStatusClass(statusText);
            const paymentText = booking.payment_method ? booking.payment_method : "Not paid";
            
            // Use booking_date (appointment date) instead of booked_at (when booking was made)
            const appointmentDate = booking.booking_date || 'Not specified';
            
            const div = document.createElement("div");
            div.classList.add("booking-card");
            div.innerHTML = `
              <h3><i class="fa-solid fa-scissors"></i> ${booking.service}</h3>
              <p><strong>Barber:</strong> ${booking.barber}</p>
              <p><strong>Time:</strong> ${booking.time}</p>
              <p><strong>Status:</strong> <span class="${statusClass}">${statusText}</span></p>
              <p><strong>Payment Method:</strong> <span class="${paymentClass}">${paymentText}</span></p>
              <p><strong>Date Booked:</strong> ${appointmentDate}</p>
              <div class="booking-actions">
                <button class="cancel-btn" data-id="${booking.id}">Cancel Booking</button>
                <button class="reschedule-btn" data-id="${booking.id}"><i class="fas fa-calendar-alt"></i> Reschedule</button>
              </div>
            `;
            container.appendChild(div);
          });

          // Add event listeners for cancel and reschedule buttons
          document.querySelectorAll('.reschedule-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const bookingId = this.getAttribute('data-id');
              openRescheduleModal(bookingId);
            });
          });

            document.querySelectorAll('.cancel-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
              const bookingId = this.getAttribute('data-id');
              // First confirmation
              const firstConfirmed = await showConfirmModal("Are you sure you want to cancel this booking?", bookingId);
              if (!firstConfirmed || firstConfirmed === 'reschedule') return;
              
              // Final confirmation
              const finalConfirmed = await showFinalConfirmModal();
              if (!finalConfirmed) return;

              try {
                const res = await fetch('/api/cancel-booking', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ bookingId })
                });
                const result = await res.json();
                if (result.success) {
                  showModal("Booking cancelled successfully! You can now make new bookings.");
                  // Remove the booking card from the DOM immediately
                  try {
                    const card = this.closest('.booking-card');
                    if (card && card.parentNode) {
                      card.parentNode.removeChild(card);
                    } else {
                      // fallback: reload if DOM removal isn't possible
                      document.getElementById("modal-ok").addEventListener("click", function() {
                        window.location.reload();
                      }, { once: true });
                    }
                  } catch (e) {
                    document.getElementById("modal-ok").addEventListener("click", function() {
                      window.location.reload();
                    }, { once: true });
                  }
                } else {
                  showModal(result.error || "Failed to cancel booking.");
                }
              } catch (error) {
                showModal("Error cancelling booking. Please try again.");
              }
            });
          });
        })
        .catch(err => {
          loading.style.display = "none";
          container.innerHTML = "<p>Error loading bookings.</p>";
          showModal("Error loading bookings. Please refresh the page.");
        });
    });

    // Services Modal Functionality
    let selectedService = null;
    const servicesModal = document.getElementById("services-modal");
    const closeModalBtn = document.querySelector(".close-services-modal");
    const serviceBoxes = document.querySelectorAll(".service-box");
    const serviceLoading = document.querySelector(".service-loading");
    const bookAnotherBtn = document.getElementById("bookAnotherBtn");

    // Book Another Appointment button event listener
    if (bookAnotherBtn) {
      bookAnotherBtn.addEventListener("click", function(e) {
        e.preventDefault();
        openServicesModal();
      });
    }

    // Open modal when Book Now (navbar) is clicked - ensure nav handler exists
    const navBookNowBtnEl = document.getElementById('navBookNowBtn');
    if (navBookNowBtnEl) {
      navBookNowBtnEl.addEventListener('click', function(e) {
        e.preventDefault();
        openServicesModal();
      });
    }

    // Provide open/close functions (copied from homepage canonical implementation)
    function openServicesModal() {
      if (!servicesModal) return;
      servicesModal.style.display = 'block';
    }

    function closeServicesModal() {
      if (!servicesModal) return;
      servicesModal.style.display = 'none';
      // Reset selection
      serviceBoxes.forEach(box => box.classList.remove('selected'));
      selectedService = null;
    }

    // Services Modal Event Listeners
    if (closeModalBtn) {
      closeModalBtn.addEventListener("click", closeServicesModal);
    }
    
    // Close modal when clicking outside
    if (servicesModal) {
      servicesModal.addEventListener("click", function(e) {
        if (e.target === servicesModal) {
          closeServicesModal();
        }
      });
    }
    
    // Close modal with Escape key
    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape" && servicesModal.style.display === "block") {
        closeServicesModal();
      }
    });

    // Handle service selection
    if (serviceBoxes && serviceBoxes.length) {
      serviceBoxes.forEach(box => {
        box.addEventListener("click", async function() {
        // Show visual selection feedback
        serviceBoxes.forEach(b => b.classList.remove("selected"));
        this.classList.add("selected");
        selectedService = this.getAttribute("data-service");
        
        // Show loading overlay
        serviceLoading.style.display = "flex";
        
        try {
          // Send selected service to backend session
          await fetch("/api/select-service", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ service: selectedService })
          });
          
          // Store service in sessionStorage
          sessionStorage.setItem("service", selectedService);
          
          // Add a small delay to show the selection feedback, then navigate
          setTimeout(() => {
            serviceLoading.style.display = "none";
            closeServicesModal();
            // Show main loading screen and navigate
            const mainLoader = document.getElementById("loading-screen");
            mainLoader.style.display = "flex";
            setTimeout(() => {
              window.location.href = "/barber";
            }, 800);
          }, 500);
          
        } catch (err) {
          console.error("Error saving service:", err);
          serviceLoading.style.display = "none";
          showModal("❌ Failed to save service. Please try again.");
          this.classList.remove("selected");
        }
      });
    });
    }

    // Load notifications and update notification count
    function loadNotifications() {
      fetch('/api/notifications')
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const unreadCount = data.notifications.filter(n => !n.is_read).length;
            const countElement = document.getElementById('notificationCount');
            if (countElement) {
              if (unreadCount > 0) {
                countElement.textContent = unreadCount;
                countElement.style.display = 'flex';
              } else {
                countElement.style.display = 'none';
              }
            }
          }
        })
        .catch(err => {
          console.error('Failed to load notifications:', err);
        });
    }
    
    // Load notifications for dropdown
    function loadDropdownNotifications() {
      const dropdownContent = document.getElementById('notificationDropdownContent');
      dropdownContent.innerHTML = '<div class="notification-loading">Loading notifications...</div>';
      
      fetch('/api/notifications')
        .then(res => res.json())
        .then(data => {
          if (data.success && data.notifications.length > 0) {
            dropdownContent.innerHTML = data.notifications
              .slice(0, 10) // Show latest 10 notifications
              .map(notif => `
                <div class="notification-dropdown-item ${notif.is_read ? '' : 'unread'}" data-id="${notif.id}">
                  <div class="notification-message">${notif.message}</div>
                  <div class="notification-date">${new Date(notif.created_at).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  })}</div>
                </div>
              `).join('');
              
            // Add click listeners to mark individual notifications as read
            document.querySelectorAll('.notification-dropdown-item.unread').forEach(item => {
              item.addEventListener('click', function() {
                markNotificationAsRead(this.dataset.id);
                this.classList.remove('unread');
              });
            });
          } else {
            dropdownContent.innerHTML = '<div class="no-notifications">No notifications available</div>';
          }
        })
        .catch(err => {
          console.error('Failed to load dropdown notifications:', err);
          dropdownContent.innerHTML = '<div class="no-notifications">Failed to load notifications</div>';
        });
    }
    
    // Mark single notification as read
    function markNotificationAsRead(notificationId) {
      fetch('/api/notifications/mark-read', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notificationId: parseInt(notificationId) })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // Update notification count
          loadNotifications();
        }
      })
      .catch(err => {
        console.error('Failed to mark notification as read:', err);
      });
    }
    
    // Mark all notifications as read
    function markAllNotificationsAsRead() {
      fetch('/api/notifications/mark-all-read', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // Remove unread class from all items
          document.querySelectorAll('.notification-dropdown-item.unread').forEach(item => {
            item.classList.remove('unread');
          });
          // Update notification count
          loadNotifications();
        }
      })
      .catch(err => {
        console.error('Failed to mark all notifications as read:', err);
      });
    }

    // ========= History Modal Functionality =========
    let historyData = [];
    let currentFilter = 'all';

    const historyModal = document.getElementById('history-modal');
    const historyBtn = document.getElementById('historyBtn');
    const closeHistoryBtn = document.querySelector('.close-history');
    const filterBtns = document.querySelectorAll('.filter-btn');
    const historyContent = document.getElementById('history-content');
    const historyEmpty = document.getElementById('history-empty');

    // Open history modal
    function openHistoryModal() {
      if (historyModal) {
        historyModal.style.display = 'block';
        loadBookingHistory();
      }
    }

    // Close history modal
    function closeHistoryModal() {
      if (historyModal) {
        historyModal.style.display = 'none';
      }
    }

    // History button event listener
    if (historyBtn) {
      historyBtn.addEventListener('click', openHistoryModal);
    }

    // Close button event listener
    if (closeHistoryBtn) {
      closeHistoryBtn.addEventListener('click', closeHistoryModal);
    }

    // Close modal when clicking outside
    if (historyModal) {
      historyModal.addEventListener('click', function(e) {
        if (e.target === historyModal) {
          closeHistoryModal();
        }
      });
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && historyModal.style.display === 'block') {
        closeHistoryModal();
      }
    });

    // Filter button event listeners
    if (filterBtns) {
      filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          // Remove active class from all buttons
          filterBtns.forEach(b => b.classList.remove('active'));
          // Add active class to clicked button
          this.classList.add('active');
          // Update current filter
          currentFilter = this.getAttribute('data-filter');
          // Filter and display history
          filterAndDisplayHistory();
        });
      });
    }

    // Load booking history from server
    async function loadBookingHistory() {
      try {
        // Show loading state
        if (historyContent) {
          historyContent.innerHTML = `
            <div class="history-loading">
              <i class="fas fa-spinner fa-spin"></i>
              Loading history...
            </div>
          `;
        }
        if (historyEmpty) {
          historyEmpty.style.display = 'none';
        }

        const response = await fetch('/api/booking-history');
        const data = await response.json();

        if (data.success) {
          historyData = data.bookings || [];
          filterAndDisplayHistory();
        } else {
          throw new Error(data.error || 'Failed to load booking history');
        }
      } catch (error) {
        console.error('Error loading booking history:', error);
        if (historyContent) {
          historyContent.innerHTML = `
            <div class="history-loading" style="color: #e74c3c;">
              <i class="fas fa-exclamation-triangle"></i>
              Failed to load booking history. Please try again.
            </div>
          `;
        }
      }
    }

    // Filter and display history based on current filter
    function filterAndDisplayHistory() {
      if (!historyData || historyData.length === 0) {
        if (historyContent) historyContent.innerHTML = '';
        if (historyEmpty) historyEmpty.style.display = 'block';
        return;
      }

      let filteredData = historyData;
      if (currentFilter !== 'all') {
        filteredData = historyData.filter(booking => {
          const status = booking.status ? booking.status.toLowerCase() : '';
          return status === currentFilter;
        });
      }

      if (filteredData.length === 0) {
        if (historyContent) historyContent.innerHTML = '';
        if (historyEmpty) {
          historyEmpty.style.display = 'block';
          historyEmpty.innerHTML = `
            <i class="fas fa-calendar-times"></i>
            <p>No ${currentFilter === 'all' ? '' : currentFilter} bookings found.</p>
          `;
        }
        return;
      }

      if (historyEmpty) historyEmpty.style.display = 'none';
      displayHistoryBookings(filteredData);
    }

    // Display history bookings
    function displayHistoryBookings(bookings) {
      if (!historyContent) return;
      
      console.log('Displaying history bookings:', bookings);

      const historyHTML = bookings.map(booking => {
        const status = booking.status ? booking.status.toLowerCase() : 'unknown';
        const statusClass = status === 'done' ? 'status-done' : 
                           status === 'cancelled' ? 'status-cancelled' : 'status-unknown';
        const statusText = booking.status || 'Unknown';
        
        // Format the dates
        const bookingDate = booking.booking_date || 'Not specified';
        const bookedAtDate = booking.booked_at ? new Date(booking.booked_at).toLocaleDateString() : 'Not specified';
        
        // Get booking details
        const barberName = booking.barber || 'Not specified';
        const timeSlot = booking.time || 'Not specified';
        const paymentMethod = booking.payment_method || 'Not specified';
        const referenceNumber = booking.reference_number || '';
        const serviceName = booking.service || 'Unknown Service';
        
        return `
          <div class="history-booking-card">
            <div class="status-badge ${statusClass}">${statusText}</div>
            <h3><i class="fa-solid fa-scissors"></i> ${serviceName}</h3>
            <div class="booking-details">
              <p><strong>Barber:</strong> ${barberName}</p>
              <p><strong>Time:</strong> ${timeSlot}</p>
              <p><strong>Appointment Date:</strong> ${bookingDate}</p>
              <p><strong>Payment Method:</strong> ${paymentMethod}</p>
              ${referenceNumber ? `<p><strong>Reference Number:</strong> ${referenceNumber}</p>` : ''}
              <p><strong>Booked On:</strong> ${bookedAtDate}</p>
            </div>
          </div>
        `;
      }).join('');

      historyContent.innerHTML = historyHTML;
    }


  </script>
  <script src="logout-confirm.js"></script>
</body>
</html>